<a href="http://danthar.tweakblogs.net/" target="_blank">Arjen Smits</a> recently submitted a patch for <a href="http://code.google.com/p/agatha-rrsl/" target="_blank">Agatha</a> which makes it possible to send One-Way (aka Fire And Forget) requests to an Agatha service layer. As you know, Agatha is a Request/Response framework where each Request sent to the service layer will receive a corresponding Response. A One-Way request doesn’t have a response however. It can be very useful when you just need the service layer to do <em>something</em> where the client that sent the request doesn’t need a response, and thus, shouldn’t have to wait for it.

The biggest benefit here is that client can simply send a One-Way request to the service layer, and instead of waiting for the service layer to process it, the call to the service layer will return <em>immediately. </em>You could achieve similar behavior by using the asynchronous service proxy and supplying an empty delegate to be called after the response was received. The downside of that is obviously that the communication channel between the client and the server would remain in use throughout the handling of the request, only to return a response later on that will be ignored anyway. Sending a One-Way request avoids this kind of waste.

Let’s see how we can use One-Way requests with Agatha. First of all, you will need to create a Request class which inherits from Agatha’s OneWayRequest class:  

<div style="font-family: consolas; background: white; color: black; font-size: 10pt">   <p style="margin: 0px"> <span style="color: blue">public</span> <span style="color: blue">abstract</span> <span style="color: blue">class</span> <span style="color: #2b91af">OneWayRequest</span> : <span style="color: #2b91af">Request</span></p>    <p style="margin: 0px"> {</p>    <p style="margin: 0px"> }</p> </div>  <p></p>  <p>Normally you’d also create a corresponding Response type for your Request type, but for Requests that inherit from OneWayRequest that’s useless. You’ll also need to create a Request Handler which inherits from Agatha’s OneWayRequestHandler class:</p>  <div style="font-family: consolas; background: white; color: black; font-size: 10pt">   <p style="margin: 0px"> <span style="color: blue">public</span> <span style="color: blue">abstract</span> <span style="color: blue">class</span> <span style="color: #2b91af">OneWayRequestHandler</span>&lt;TRequest&gt; : <span style="color: #2b91af">OneWayRequestHandler</span>, <span style="color: #2b91af">IOneWayRequestHandler</span>&lt;TRequest&gt; <span style="color: blue">where</span> TRequest : <span style="color: #2b91af">OneWayRequest</span></p>    <p style="margin: 0px"> {</p>    <p style="margin: 0px"> <span style="color: blue">public</span> <span style="color: blue">override</span> <span style="color: blue">void</span> Handle(<span style="color: #2b91af">OneWayRequest</span> request)</p>    <p style="margin: 0px"> {</p>    <p style="margin: 0px"> <span style="color: blue">var</span> typedRequest = (TRequest) request;</p>    <p style="margin: 0px"> BeforeHandle(typedRequest);</p>    <p style="margin: 0px"> Handle(typedRequest);</p>    <p style="margin: 0px"> AfterHandle(typedRequest);</p>    <p style="margin: 0px"> }</p>    <p style="margin: 0px"></p>    <p style="margin: 0px"> <span style="color: blue">public</span> <span style="color: blue">virtual</span> <span style="color: blue">void</span> BeforeHandle(TRequest request) { }</p>    <p style="margin: 0px"> <span style="color: blue">public</span> <span style="color: blue">virtual</span> <span style="color: blue">void</span> AfterHandle(TRequest request) { }</p>    <p style="margin: 0px"></p>    <p style="margin: 0px"> <span style="color: blue">public</span> <span style="color: blue">abstract</span> <span style="color: blue">void</span> Handle(TRequest request);</p>    <p style="margin: 0px"> }</p> </div> 

This is very similar to a regular RequestHandler, except that there’s no way for you to return a response. Simply inherit from this class, implement the Handle(TRequest) method to perform whatever it is that you need to do and that’s it as far as the service layer is concerned. If you want to, you can (as always) override the BeforeHandle and AfterHandle methods to add some extra stuff. If you don’t want to inherit from this OneWayRequestHandler class, you can just as well create a class which implements Agatha’s IOneWayRequestHandler&lt;TRequest&gt; interface. Your One Way Request Handlers will be picked up and registered by Agatha automatically, just as it does with regular Request Handlers.

As for sending One Way Requests to your service layer, you can do that with both the synchronous IRequestDispatcher and the IAsyncRequestDispatcher. The IRequestDispatcher interface now looks like this:

<div style="font-family: consolas; background: white; color: black; font-size: 10pt">   <p style="margin: 0px"> <span style="color: blue">public</span> <span style="color: blue">interface</span> <span style="color: #2b91af">IRequestDispatcher</span> : <span style="color: #2b91af">IDisposable</span></p>    <p style="margin: 0px"> {</p>    <p style="margin: 0px"> <span style="color: #2b91af">IEnumerable</span>&lt;<span style="color: #2b91af">Response</span>&gt; Responses { <span style="color: blue">get</span>; }</p>    <p style="margin: 0px"></p>    <p style="margin: 0px"> <span style="color: blue">void</span> Add(<span style="color: #2b91af">Request</span> request);</p>    <p style="margin: 0px"> <span style="color: blue">void</span> Add(<span style="color: blue">params</span> <span style="color: #2b91af">Request</span>[] requestsToAdd);</p>    <p style="margin: 0px"> <span style="color: blue">void</span> Add(<span style="color: blue">string</span> key, <span style="color: #2b91af">Request</span> request);</p>    <p style="margin: 0px"> <span style="color: blue">void</span> Send(<span style="color: blue">params</span> <span style="color: #2b91af">OneWayRequest</span>[] oneWayRequests);</p>    <p style="margin: 0px"> <span style="color: blue">bool</span> HasResponse&lt;TResponse&gt;() <span style="color: blue">where</span> TResponse : <span style="color: #2b91af">Response</span>;</p>    <p style="margin: 0px"> TResponse Get&lt;TResponse&gt;() <span style="color: blue">where</span> TResponse : <span style="color: #2b91af">Response</span>;</p>    <p style="margin: 0px"> TResponse Get&lt;TResponse&gt;(<span style="color: blue">string</span> key) <span style="color: blue">where</span> TResponse : <span style="color: #2b91af">Response</span>;</p>    <p style="margin: 0px"> TResponse Get&lt;TResponse&gt;(<span style="color: #2b91af">Request</span> request) <span style="color: blue">where</span> TResponse : <span style="color: #2b91af">Response</span>;</p>    <p style="margin: 0px"> <span style="color: blue">void</span> Clear();</p>    <p style="margin: 0px"> }</p> </div>

Sending OneWayRequests can be done through the Send method, which will immediately send the given OneWayRequests to the service layer and the call will return as soon as the requests have been transmitted. This means that this call will block for a short time until the requests have actually been <em>sent</em>. It will return before the requests are actually processed by the service layer however.

The IAsyncRequestDispatcher now looks like this:

<div style="font-family: consolas; background: white; color: black; font-size: 10pt">   <p style="margin: 0px"> <span style="color: blue">public</span> <span style="color: blue">interface</span> <span style="color: #2b91af">IAsyncRequestDispatcher</span> : <span style="color: #2b91af">IDisposable</span></p>    <p style="margin: 0px"> {</p>    <p style="margin: 0px"> <span style="color: blue">void</span> Add(<span style="color: #2b91af">Request</span> request);</p>    <p style="margin: 0px"> <span style="color: blue">void</span> Add(<span style="color: blue">params</span> <span style="color: #2b91af">Request</span>[] requestsToAdd);</p>    <p style="margin: 0px"> <span style="color: blue">void</span> Add(<span style="color: blue">string</span> key, <span style="color: #2b91af">Request</span> request);</p>    <p style="margin: 0px"> <span style="color: blue">void</span> Add(<span style="color: blue">params</span> <span style="color: #2b91af">OneWayRequest</span>[] oneWayRequests);</p>    <p style="margin: 0px"> <span style="color: blue">void</span> ProcessOneWayRequests();</p>    <p style="margin: 0px"> <span style="color: blue">void</span> ProcessRequests(<span style="color: #2b91af">Action</span>&lt;<span style="color: #2b91af">ReceivedResponses</span>&gt; receivedResponsesDelegate, <span style="color: #2b91af">Action</span>&lt;<span style="color: #2b91af">ExceptionInfo</span>&gt; exceptionOccurredDelegate);</p>    <p style="margin: 0px"> <span style="color: blue">void</span> ProcessRequests(<span style="color: #2b91af">Action</span>&lt;<span style="color: #2b91af">ReceivedResponses</span>&gt; receivedResponsesDelegate, <span style="color: #2b91af">Action</span>&lt;<span style="color: #2b91af">ExceptionInfo</span>, <span style="color: #2b91af">ExceptionType</span>&gt; exceptionAndTypeOccurredDelegate);</p>    <p style="margin: 0px"> }</p> </div>

You can add your OneWayRequest through the correct Add method, and then have them processed by the server by calling the ProcessOneWayRequests method. This call will not block and will return <em>immediately</em>. That means that it won’t wait until the requests have actually been sent to the server like it does with the IRequestDispatcher.