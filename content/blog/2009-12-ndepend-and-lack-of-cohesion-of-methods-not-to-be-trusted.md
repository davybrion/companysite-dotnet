<p>I already <a href="http://davybrion.com/blog/2009/12/which-code-metrics-do-you-consider-important/" target="_blank">mentioned</a> that i don’t trust the Lack Of Cohesion Of Methods (LOCM) metric from NDepend on the type level.&#160; Let’s go over a small example, shall we?</p>  <p>Suppose you have a class like this:</p>  <div style="font-family: consolas; background: white; color: black; font-size: 10pt">   <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">CohesiveClass</span></p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: #2b91af">List</span>&lt;<span style="color: blue">int</span>&gt; integers;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">public</span> CohesiveClass()</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; integers = <span style="color: blue">new</span> <span style="color: #2b91af">List</span>&lt;<span style="color: blue">int</span>&gt;();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">void</span> AddInteger()</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; integers.Add(integers.Count);&#160;&#160;&#160; </p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: #2b91af">IEnumerable</span>&lt;<span style="color: blue">int</span>&gt; GetEvenIntegers()</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> integers.Where(i =&gt; i % 2 == 0);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: #2b91af">IEnumerable</span>&lt;<span style="color: blue">int</span>&gt; GetOddIntegers()</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> integers.Where(i =&gt; i % 2 &gt; 0);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p> </div>  <p>&#160;</p>  <p>If you look at the <a href="http://ndepend.com/Metrics.aspx#LCOM" target="_blank">NDepend LOCM documentation</a>, you can find the following statement:</p>  <blockquote>   <p>a class is utterly cohesive if all its methods use all its instance fields</p> </blockquote>  <p>Now, unless i’m missing a fundamental concept here, i would dare to claim that the class shown above is utterly cohesive.&#160; After all, each method uses the 1 instance field of this class. </p>  <p>This is how NDepend is supposed to calculate the LOCM metric (taken from the documentation):</p>  <blockquote>   <p>There are several LCOM metrics. The LCOM takes its values in the range [0-1]. The LCOM HS (HS stands for Henderson-Sellers) takes its values in the range [0-2]. A LCOM HS value highest than 1 should be considered alarming. Here are algorithms used by NDepend to compute LCOM metrics: </p>    <ul>     <li>LCOM = 1 – (sum(MF)/M*F) </li>      <li>LCOM HS = (M – sum(MF)/F)(M-1) </li>   </ul> Where:     <ul>     <li>M is the number of methods in class (both static and instance methods are counted, it includes also constructors, properties getters/setters, events add/remove methods). </li>      <li>F is the number of instance fields in the class. </li>      <li>MF is the number of methods of the class accessing a particular instance field. </li>      <li>Sum(MF) is the sum of MF over all instance fields of the class. </li>   </ul>    <br />The underlying idea behind these formulas can be stated as follow: a class is utterly cohesive if all its methods use all its instance fields, which means that sum(MF)=M*F and then LCOM = 0 and LCOMHS = 0</blockquote>  <p>I may suck at math, but i think that both LCOM and LCOM HS should be 0 for the code shown above.&#160; NDepend however disagrees with me.&#160; LCOM for this class, as calculated by NDepend is 0.33 and LCOM HS is 0.4.&#160; In both cases NDepend considers these values to be bad for this class (as indicated by the fact that the IsBadLackOfCohesionOfMethods and IsBadLackOfCohesionOfMethods_HS values in TypesMetrics.xml are set to True).</p>  <p>Of course, it also reports that there are 3 fields in this type, instead of one (NFields is set to 3) and 2 static methods along with the 4 instance methods.&#160; I’m sure you can agree with me that there are no static methods, and only one field.</p>  <p>Now, if you look at the compiled code in reflector, it suddenly makes sense:</p>  <p><a href="http://davybrion.com/blog/wp-content/uploads/2009/12/reflector_output.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="reflector_output" border="0" alt="reflector_output" src="http://davybrion.com/blog/wp-content/uploads/2009/12/reflector_output_thumb.png" width="429" height="227" /></a> </p>  <p>Alright, so we do have 3 fields: my integers list, and 2 Func instances that the C# compiler generated for me.&#160; And the 2 static methods that were listed by NDepend also show up, and they contain the code of my lambda expressions.</p>  <p>Now here is my question: if a tool calculates metrics of code, shouldn’t it calculate them based on the code that <em>i wrote</em>, instead of the code that <em>the compiler generated</em>?&#160; Especially when it comes to metrics that are supposed to give you an idea on the quality of the code, i would really prefer it that <em>my code</em> was used for the calculation, without the <em>compiler generated </em>code.</p>  <p>Let’s try to make NDepend agree with me that this code is indeed utterly cohesive, shall we?</p>  <p>Here’s a modified version of the code:</p>  <div style="font-family: consolas; background: white; color: black; font-size: 10pt">   <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">CohesiveClass</span></p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: #2b91af">List</span>&lt;<span style="color: blue">int</span>&gt; integers;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">public</span> CohesiveClass()</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; integers = <span style="color: blue">new</span> <span style="color: #2b91af">List</span>&lt;<span style="color: blue">int</span>&gt;();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">void</span> AddInteger()</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; integers.Add(integers.Count);&#160;&#160;&#160; </p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: #2b91af">IEnumerable</span>&lt;<span style="color: blue">int</span>&gt; GetEvenIntegers()</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> evenInts = <span style="color: blue">new</span> <span style="color: #2b91af">List</span>&lt;<span style="color: blue">int</span>&gt;();</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">foreach</span> (<span style="color: blue">var</span> i <span style="color: blue">in</span> integers)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (i % 2 == 0)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; evenInts.Add(i);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> evenInts;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: #2b91af">IEnumerable</span>&lt;<span style="color: blue">int</span>&gt; GetOddIntegers()</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> evenInts = <span style="color: blue">new</span> <span style="color: #2b91af">List</span>&lt;<span style="color: blue">int</span>&gt;();</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">foreach</span> (<span style="color: blue">var</span> i <span style="color: blue">in</span> integers)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (i % 2 &gt; 0)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; evenInts.Add(i);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> evenInts;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p> </div>  <p>&#160;</p>  <p>NDepend will now gladly agree with me that LCOM and LCOM HS are 0 and that the class is utterly cohesive.</p>  <p>I don’t know about you, but i’ll take version 1 over version 2 any day of the week.</p>  <p>Until this issue is fixed (and who knows how many other metrics show incorrect results based on compiler generated code), i’ll assess the quality of my code myself instead of depending on a tool, thank you very much.</p>